<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planejador Diário</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .hidden{ display:none; }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .spinner{ border:4px solid rgba(0,0,0,.1); width:36px;height:36px;border-radius:50%;border-left-color:#3b82f6;animation:spin 1s linear infinite }
    .weekday-checkbox:checked + label { background:#3b82f6;color:#fff;border-color:#3b82f6 }
    .calendar-grid{ display:grid; height:1200px } /* 24h x 50px */
    .time-slot{ height:50px }
    .day-column{ position:relative; border-left:1px solid #e5e7eb }
    .task-block{
      position:absolute; left:2px; right:2px; border-radius:6px; padding:6px 8px;
      color:#fff; font-size:.8rem; overflow:hidden; cursor:pointer; border:1px solid rgba(0,0,0,.08)
    }
    .task-block small{ opacity:.9; display:block; margin-top:2px }
    /* mobile */
    @media (max-width:768px){
      .main-header{ flex-direction:column; align-items:flex-start; gap:1rem }
      .controls-container{ flex-direction:column; align-items:flex-start; width:100% }
      .calendar-grid{ grid-template-columns:40px 1fr !important }
      .task-block{ font-size:.7rem }
      #task-modal-content{ padding:1.25rem }
      h1{ font-size:1.5rem }
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <!-- loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="spinner"></div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="w-full max-w-md p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Login</h2>
      <form id="login-form" autocomplete="off">
        <div class="mb-4">
          <label for="login-cpf" class="block text-gray-700 font-semibold mb-2">CPF</label>
          <input type="text" id="login-cpf" inputmode="numeric" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="000.000.000-00" required>
        </div>
        <div class="mb-4">
          <label for="login-nascimento" class="block text-gray-700 font-semibold mb-2">Data de Nascimento</label>
          <input type="date" id="login-nascimento" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-6">
          <label for="login-senha" class="block text-gray-700 font-semibold mb-2">Senha</label>
          <input type="password" id="login-senha" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="********" required>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">Entrar</button>
      </form>
      <p class="text-center text-gray-600 mt-4">Não tem uma conta? <a href="#" id="show-register" class="text-blue-600 hover:underline font-semibold">Cadastre-se</a></p>
    </div>
  </div>

  <!-- CADASTRO -->
  <div id="register-screen" class="w-full max-w-md p-4 hidden">
    <div class="bg-white p-8 rounded-xl shadow-lg">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Cadastro</h2>
      <form id="register-form" autocomplete="off">
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded-md">
          <p class="font-bold">Atenção!</p>
          <p>Use uma senha simples e única para este site. Não reutilize senhas importantes.</p>
        </div>
        <div class="mb-4">
          <label for="register-nome" class="block text-gray-700 font-semibold mb-2">Nome Completo</label>
          <input type="text" id="register-nome" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label for="register-cpf" class="block text-gray-700 font-semibold mb-2">CPF</label>
          <input type="text" id="register-cpf" inputmode="numeric" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
          <label for="register-nascimento" class="block text-gray-700 font-semibold mb-2">Data de Nascimento</label>
          <input type="date" id="register-nascimento" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-6">
          <label for="register-senha" class="block text-gray-700 font-semibold mb-2">Senha</label>
          <input type="password" id="register-senha" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Cadastrar</button>
      </form>
      <p class="text-center text-gray-600 mt-4">Já tem uma conta? <a href="#" id="show-login" class="text-blue-600 hover:underline font-semibold">Faça Login</a></p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-screen" class="w-full max-w-7xl hidden p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <div class="main-header flex justify-between items-center mb-6 pb-4 border-b">
        <h1 class="text-3xl font-bold text-gray-800">Minha Agenda</h1>
        <div class="flex items-center gap-3">
          <p class="text-gray-700">Bem-vindo(a), <span id="user-name" class="font-semibold"></span>!</p>
          <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
      </div>

      <div class="controls-container flex flex-wrap gap-4 mb-6">
        <button id="add-task-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
          <i class="fas fa-plus"></i> Adicionar Atividade
        </button>

        <div class="flex rounded-lg border overflow-hidden">
          <button id="view-daily-btn" class="py-2 px-4 text-gray-600 font-semibold bg-gray-100">Visão Diária</button>
          <button id="view-weekly-btn" class="bg-blue-500 text-white font-semibold py-2 px-4">Visão Semanal</button>
        </div>

        <div id="date-navigation" class="hidden items-center gap-4">
          <button id="prev-day-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><i class="fas fa-chevron-left"></i></button>
          <h3 id="current-date-display" class="text-lg font-semibold text-center w-56 whitespace-nowrap"></h3>
          <button id="next-day-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>

      <div id="calendar-container" class="overflow-x-auto"></div>
    </div>
  </div>

  <!-- MODAL TAREFA -->
  <div id="task-modal" class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4 hidden">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md transform transition-all overflow-y-auto max-h-screen" id="task-modal-content">
      <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Nova Atividade</h3>
      <form id="task-form" class="space-y-4">
        <input type="hidden" id="task-id">
        <div>
          <label for="task-name" class="block text-gray-700 font-semibold mb-2">Nome da Atividade</label>
          <input type="text" id="task-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label for="task-color" class="block text-gray-700 font-semibold mb-2">Cor da Atividade</label>
          <input type="color" id="task-color" class="w-full h-10 px-1 py-1 border rounded-lg" value="#3b82f6">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="task-start-day" class="block text-gray-700 font-semibold mb-2">Data de Início</label>
            <input type="date" id="task-start-day" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          <div id="end-date-container">
            <label for="task-end-day" class="block text-gray-700 font-semibold mb-2">Data de Fim</label>
            <input type="date" id="task-end-day" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="task-start-time" class="block text-gray-700 font-semibold mb-2">Horário Início</label>
            <input type="time" id="task-start-time" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          <div>
            <label for="task-end-time" class="block text-gray-700 font-semibold mb-2">Horário Fim</label>
            <input type="time" id="task-end-time" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div>
          <label for="task-repetition" class="block text-gray-700 font-semibold mb-2">Repetir</label>
          <select id="task-repetition" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            <option value="nenhuma">Não repetir</option>
            <option value="diaria">Diariamente</option>
            <option value="semanal">Semanalmente</option>
          </select>
        </div>

        <div id="weekdays-selection" class="hidden pb-2">
          <label class="block text-gray-700 font-semibold mb-2">Quais dias?</label>
          <div class="grid grid-cols-7 gap-2 text-center">
            <!-- 0=Dom ... 6=Sáb -->
            <div><input type="checkbox" id="weekday-0" value="0" class="weekday-checkbox hidden"><label for="weekday-0" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">D</label></div>
            <div><input type="checkbox" id="weekday-1" value="1" class="weekday-checkbox hidden"><label for="weekday-1" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">S</label></div>
            <div><input type="checkbox" id="weekday-2" value="2" class="weekday-checkbox hidden"><label for="weekday-2" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">T</label></div>
            <div><input type="checkbox" id="weekday-3" value="3" class="weekday-checkbox hidden"><label for="weekday-3" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">Q</label></div>
            <div><input type="checkbox" id="weekday-4" value="4" class="weekday-checkbox hidden"><label for="weekday-4" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">Q</label></div>
            <div><input type="checkbox" id="weekday-5" value="5" class="weekday-checkbox hidden"><label for="weekday-5" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">S</label></div>
            <div><input type="checkbox" id="weekday-6" value="6" class="weekday-checkbox hidden"><label for="weekday-6" class="cursor-pointer p-2 rounded-full border w-10 h-10 inline-flex items-center justify-center">S</label></div>
          </div>
        </div>

        <div class="flex justify-between items-center gap-4 pt-4">
          <button type="button" id="delete-task-btn-modal" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg hidden"><i class="fas fa-trash-alt"></i> Excluir</button>
          <div class="flex justify-end gap-4 flex-grow">
            <button type="button" id="cancel-task-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyHJIkDXzKwhVk_mSC8jamkp13CJkvwYy0E_esZch8bZfvO7v1dm-4mmn89rD6A6Wi1/exec';

    // elements
    const screens = {
      login: document.getElementById('login-screen'),
      register: document.getElementById('register-screen'),
      app: document.getElementById('app-screen'),
    };
    const forms = {
      login: document.getElementById('login-form'),
      register: document.getElementById('register-form'),
      task: document.getElementById('task-form'),
    };
    const buttons = {
      showRegister: document.getElementById('show-register'),
      showLogin: document.getElementById('show-login'),
      logout: document.getElementById('logout-btn'),
      addTask: document.getElementById('add-task-btn'),
      cancelTask: document.getElementById('cancel-task-btn'),
      deleteTaskModal: document.getElementById('delete-task-btn-modal'),
      viewDaily: document.getElementById('view-daily-btn'),
      viewWeekly: document.getElementById('view-weekly-btn'),
      prevDay: document.getElementById('prev-day-btn'),
      nextDay: document.getElementById('next-day-btn'),
    };
    const taskModal = document.getElementById('task-modal');
    const calendarContainer = document.getElementById('calendar-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    const repetitionSelect = document.getElementById('task-repetition');
    const weekdaysSelection = document.getElementById('weekdays-selection');
    const endDateContainer = document.getElementById('end-date-container');
    const dateNavigation = document.getElementById('date-navigation');
    const currentDateDisplay = document.getElementById('current-date-display');

    const $ = (sel) => document.querySelector(sel);

    // state
    let currentUser = null;
    let userTasks = [];
    let currentViewMode = 'weekly';
    let currentDate = new Date();

    // utils
    const showLoading = (show) => loadingOverlay.classList.toggle('hidden', !show);
    const showAlert = (message) => alert(message);
    const showScreen = (name) => { Object.values(screens).forEach(s => s.classList.add('hidden')); screens[name].classList.remove('hidden'); };

    function normalizeCPF(raw){
      return String(raw||'').replace(/\D/g,''); // só dígitos
    }

    // substitua sua apiCall por esta (lendo texto e tentando JSON)
async function apiCall(action, payload = {}) {
  showLoading(true);
  try {
    const resp = await fetch(WEB_APP_URL, {
      method: 'POST',
      mode: 'cors',
      redirect: 'follow',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action, ...payload }),
    });

    const raw = await resp.text();
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    let result;
    try { result = JSON.parse(raw); }
    catch { console.error('Resposta não-JSON:', raw); throw new Error('Web App não retornou JSON (ver implantação/permissões).'); }

    if (result.status === 'error') throw new Error(result.message);
    return result;
  } catch (err) {
    console.error('apiCall erro:', err);
    showAlert(`Erro na comunicação: ${err.message}`);
    return null;
  } finally { showLoading(false); }
}

    // auth
    const handleLogin = async (e) => {
      e.preventDefault();
      const cpf = normalizeCPF($('#login-cpf').value);
      if (cpf.length !== 11) return showAlert('CPF inválido.');
      const result = await apiCall('login', {
        cpf,
        dataNascimento: $('#login-nascimento').value,
        senha: $('#login-senha').value
      });
      if (result && result.user) {
        currentUser = result.user;
        sessionStorage.setItem('dailyPlannerUser', JSON.stringify(currentUser));
        initializeApp();
      }
    };

    const handleRegister = async (e) => {
      e.preventDefault();
      const cpf = normalizeCPF($('#register-cpf').value);
      if (cpf.length !== 11) return showAlert('CPF inválido.');
      const result = await apiCall('register', {
        nome: $('#register-nome').value.trim(),
        cpf,
        dataNascimento: $('#register-nascimento').value,
        senha: $('#register-senha').value
      });
      if (result) {
        showAlert('Cadastro realizado com sucesso! Faça o login.');
        forms.register.reset();
        showScreen('login');
      }
    };

    const handleLogout = () => {
      currentUser = null;
      sessionStorage.removeItem('dailyPlannerUser');
      userTasks = [];
      calendarContainer.innerHTML = '';
      showScreen('login');
    };

    const fetchTasks = async () => {
  if (!currentUser) return;
  const result = await apiCall('getTasks', { cpf: currentUser.cpf });
  console.log('getTasks result:', result);
  if (result && result.tasks) {
    console.table(result.tasks);
    userTasks = result.tasks;
    renderCalendar();
  }
};


    const handleSaveTask = async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const selectedDays = Array.from(document.querySelectorAll('.weekday-checkbox:checked')).map(cb => cb.value);
      const rep = repetitionSelect.value;

      const startDay = $('#task-start-day').value;
      const endDay = $('#task-end-day').value;

      if (rep === 'semanal' && selectedDays.length === 0) {
        return showAlert('Selecione ao menos um dia da semana.');
      }

      const startTime = $('#task-start-time').value;
      const endTime = $('#task-end-time').value;
      if (endTime && startTime && endTime <= startTime) {
        return showAlert('Horário fim deve ser maior que o início.');
      }

      const taskData = {
        id_atividade: $('#task-id').value,
        cpf_usuario: currentUser.cpf,
        atividade: $('#task-name').value.trim(),
        cor: $('#task-color').value || '#3b82f6',
        dia_inicio: startDay,
        dia_fim: rep === 'nenhuma' ? '' : (endDay || ''),
        horario_inicio: startTime,
        horario_fim: endTime || '',
        repeticao: rep,
        dias_semana: rep === 'semanal' ? selectedDays.join(',') : '',
      };

      const result = await apiCall('saveTask', taskData);
      if (result) {
        closeTaskModal();
        fetchTasks();
      }
    };

    const handleDeleteTask = async () => {
      const id = $('#task-id').value;
      if (!id) return;
      if (!confirm('Tem certeza que deseja excluir esta atividade?')) return;
      const result = await apiCall('deleteTask', { id_atividade: id, cpf_usuario: currentUser?.cpf });
      if (result) {
        closeTaskModal();
        fetchTasks();
      }
    };

    const openTaskModal = (task = null) => {
      forms.task.reset();
      document.querySelectorAll('.weekday-checkbox').forEach(cb => cb.checked = false);
      weekdaysSelection.classList.add('hidden');
      buttons.deleteTaskModal.classList.add('hidden');
      $('#task-color').value = '#3b82f6';
      repetitionSelect.value = 'nenhuma';
      endDateContainer.classList.remove('hidden');

      if (task) {
        $('#modal-title').innerText = 'Editar Atividade';
        buttons.deleteTaskModal.classList.remove('hidden');
        $('#task-id').value = task.id_atividade || '';
        $('#task-name').value = task.atividade || '';
        $('#task-color').value = task.cor || '#3b82f6';
        $('#task-start-day').value = task.dia_inicio || '';
        $('#task-end-day').value = task.dia_fim || '';
        $('#task-start-time').value = task.horario_inicio || '';
        $('#task-end-time').value = task.horario_fim || '';
        repetitionSelect.value = (task.repeticao || 'nenhuma').trim();

        if (repetitionSelect.value === 'semanal') {
          weekdaysSelection.classList.remove('hidden');
          String(task.dias_semana || '')
            .split(',')
            .filter(Boolean)
            .forEach(d => {
              const cb = document.getElementById(`weekday-${d}`);
              if (cb) cb.checked = true;
            });
        }
        if (repetitionSelect.value === 'nenhuma') {
          // fim opcional oculto
          // (deixa visível para permitir converter para recorrente se quiser)
        }
      } else {
        $('#modal-title').innerText = 'Nova Atividade';
        $('#task-id').value = '';
        $('#task-start-day').valueAsDate = new Date();
      }
      taskModal.classList.remove('hidden');
    };

    const closeTaskModal = () => taskModal.classList.add('hidden');

    repetitionSelect.addEventListener('change', () => {
      const val = repetitionSelect.value;
      weekdaysSelection.classList.toggle('hidden', val !== 'semanal');
      // fim visível para diária/semanal, opcional para nenhuma
      endDateContainer.classList.toggle('hidden', false);
    });

    function timeToMinutes(t){
      if(!t) return 0;
      const [h,m] = t.split(':').map(Number);
      return (h*60)+(m||0);
    }

    function startOfWeekMonday(date){
      const d = new Date(date);
      const day = d.getDay(); // 0=Dom
      const diff = (day === 0 ? -6 : 1 - day); // segunda como início
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatBRDate(d){
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function ensureEndDate(d){
      // se não houver data fim, usa um sentinela bem distante
      const x = new Date('9999-12-31');
      x.setHours(0,0,0,0);
      return x;
    }

    function headerDayName(idx){
      return ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][idx];
    }

    function renderCalendar(){
      calendarContainer.innerHTML = '';
      const isWeekly = currentViewMode === 'weekly';
      const daysToShow = isWeekly ? 7 : 1;

      const grid = document.createElement('div');
      grid.className = 'calendar-grid';
      grid.style.gridTemplateColumns = `50px repeat(${daysToShow}, 1fr)`;

      // cabeçalho vazio coluna de horas
      grid.innerHTML += '<div></div>';

      let baseDate;
      if (isWeekly){
        baseDate = startOfWeekMonday(currentDate);
      } else {
        baseDate = new Date(currentDate);
        baseDate.setHours(0,0,0,0);
        const options = { weekday:'long', day:'numeric', month:'long' };
        currentDateDisplay.textContent = baseDate.toLocaleDateString('pt-BR', options);
      }

      // cabeçalhos por dia
      for (let i=0;i<daysToShow;i++){
        const day = new Date(baseDate);
        day.setDate(baseDate.getDate()+i);
        grid.innerHTML += `
          <div class="text-center font-bold p-2 border-b-2">
            <p>${headerDayName(day.getDay())}</p>
            <p class="text-gray-500 font-normal">${formatBRDate(day)}</p>
          </div>`;
      }

      // coluna de horas
      const timeColumn = document.createElement('div');
      for (let i=0;i<24;i++){
        timeColumn.innerHTML += `<div class="time-slot text-right pr-2 text-sm text-gray-500 border-r border-t">${String(i).padStart(2,'0')}:00</div>`;
      }
      grid.appendChild(timeColumn);

      // colunas de dias
      const dayColumns = [];
      for (let i=0;i<daysToShow;i++){
        const col = document.createElement('div');
        col.className = 'day-column';
        for (let j=0;j<24;j++) col.innerHTML += '<div class="time-slot border-t"></div>';
        grid.appendChild(col);
        dayColumns.push(col);
      }

      const viewStart = new Date(baseDate);
      viewStart.setHours(0,0,0,0);

      // desenha atividades
      userTasks.forEach(task => {
        // datas
        const [ys,ms,ds] = String(task.dia_inicio||'').split('-').map(Number);
        if (!ys || !ms || !ds) return;
        const startDate = new Date(ys, (ms-1), ds); startDate.setHours(0,0,0,0);

        let endDate = ensureEndDate();
        if (task.dia_fim && /^\d{4}-\d{2}-\d{2}$/.test(task.dia_fim)) {
          const [ye,me,de] = task.dia_fim.split('-').map(Number);
          const tmp = new Date(ye, (me-1), de);
          if (!isNaN(tmp)) { endDate = tmp; endDate.setHours(0,0,0,0); }
        }

        for (let i=0;i<daysToShow;i++){
          const day = new Date(viewStart);
          day.setDate(viewStart.getDate()+i);

          if (day < startDate || day > endDate) continue;

          const rep = (task.repeticao || 'nenhuma').trim();
          let visible = false;
          if (rep === 'diaria') visible = true;
          else if (rep === 'semanal'){
            const dw = String(day.getDay());
            const list = String(task.dias_semana||'').split(',').filter(Boolean);
            visible = list.includes(dw);
          } else { // nenhuma
            visible = day.getTime() === startDate.getTime();
          }

          if (!visible) continue;

          const startMin = timeToMinutes(task.horario_inicio);
          const endMin = task.horario_fim ? timeToMinutes(task.horario_fim) : (startMin + 60);
          const duration = Math.max(30, endMin - startMin); // no mínimo 30min p/ visibilidade

          const top = (startMin / 60) * 50;
          const height = (duration / 60) * 50;

          const el = document.createElement('div');
          el.className = 'task-block';
          el.style.top = `${top}px`;
          el.style.height = `${height}px`;
          el.style.backgroundColor = task.cor || '#3b82f6';
          el.innerHTML = `<strong>${task.atividade || 'Atividade'}</strong><small>${task.horario_inicio || ''}${task.horario_fim ? ' — ' + task.horario_fim : ''}</small>`;
          el.addEventListener('click', () => openTaskModal(task));

          // empilha se houver sobreposição simples
          const siblings = dayColumns[i].querySelectorAll('.task-block');
          el.style.left = `${2 + (siblings.length*6)}px`;
          el.style.right = `${2}px`;

          dayColumns[i].appendChild(el);
        }
      });

      calendarContainer.appendChild(grid);
    }

    function initializeApp(){
      if (currentUser){
        document.getElementById('user-name').textContent = (currentUser.nome||'').split(' ')[0] || 'Usuário';
        showScreen('app');
        updateViewButtons();
        fetchTasks();
      } else {
        showScreen('login');
      }
    }

    function updateViewButtons(){
      const isWeekly = currentViewMode === 'weekly';
      // weekly button
      buttons.viewWeekly.classList.toggle('bg-blue-500', isWeekly);
      buttons.viewWeekly.classList.toggle('text-white', isWeekly);
      buttons.viewWeekly.classList.toggle('bg-gray-100', !isWeekly);
      buttons.viewWeekly.classList.toggle('text-gray-600', !isWeekly);
      // daily button
      buttons.viewDaily.classList.toggle('bg-blue-500', !isWeekly);
      buttons.viewDaily.classList.toggle('text-white', !isWeekly);
      buttons.viewDaily.classList.toggle('bg-gray-100', isWeekly);
      buttons.viewDaily.classList.toggle('text-gray-600', isWeekly);
      // nav visible only in daily
      dateNavigation.classList.toggle('hidden', isWeekly);
      if (!isWeekly) {
        const options = { weekday:'long', day:'numeric', month:'long' };
        const d = new Date(currentDate); d.setHours(0,0,0,0);
        currentDateDisplay.textContent = d.toLocaleDateString('pt-BR', options);
      }
    }

    // events
    buttons.viewDaily.addEventListener('click', () => {
      currentViewMode = 'daily';
      updateViewButtons();
      renderCalendar();
    });
    buttons.viewWeekly.addEventListener('click', () => {
      currentViewMode = 'weekly';
      currentDate = new Date();
      updateViewButtons();
      renderCalendar();
    });
    buttons.prevDay.addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate()-1);
      renderCalendar();
    });
    buttons.nextDay.addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate()+1);
      renderCalendar();
    });

    forms.login.addEventListener('submit', handleLogin);
    forms.register.addEventListener('submit', handleRegister);
    forms.task.addEventListener('submit', handleSaveTask);

    buttons.showRegister?.addEventListener('click', (e) => { e.preventDefault(); showScreen('register'); });
    buttons.showLogin?.addEventListener('click', (e) => { e.preventDefault(); showScreen('login'); });
    buttons.logout.addEventListener('click', handleLogout);
    buttons.addTask.addEventListener('click', () => openTaskModal());
    buttons.cancelTask.addEventListener('click', closeTaskModal);
    buttons.deleteTaskModal.addEventListener('click', handleDeleteTask);

    // restore session
    const saved = sessionStorage.getItem('dailyPlannerUser');
    if (saved) currentUser = JSON.parse(saved);
    initializeApp();
  });
  </script>
</body>
</html>
